===============================================================================
TOXICOLOGY SCHEMA INTEGRATION - COMPLETE GUIDE
===============================================================================

üéØ YOUR QUESTION
----------------
"Based on the helper functions you just modified, how can I integrate it 
to my hybrid approach?"

‚úÖ ANSWER
---------
Follow the step-by-step guide in COMPLETE_TOXICOLOGY_INTEGRATION.md

===============================================================================
üìÅ FILES FOR YOUR TOXICOLOGY INTEGRATION
===============================================================================

1. TOXICOLOGY_SCHEMA_HELPERS.md
   ‚Üí Customized helper functions for your exact schema
   ‚Üí Understands: acute_toxicity, NOAEL, DAP, etc.
   ‚Üí Validates: reference, data, source, statement, replaced

2. COMPLETE_TOXICOLOGY_INTEGRATION.md  ‚≠ê START HERE
   ‚Üí Step-by-step integration guide
   ‚Üí Copy/paste code snippets
   ‚Üí Testing instructions
   ‚Üí Troubleshooting

3. YOUR_INTEGRATION_QUICKSTART.md
   ‚Üí General quick start (still useful)

===============================================================================
‚ö° QUICK INTEGRATION (1 HOUR)
===============================================================================

Phase 1: Preparation (5 min)
  ‚òê Backup code
  ‚òê Install jsonpatch

Phase 2: Add Code (20 min)
  ‚òê Add imports
  ‚òê Add JSONPatchOperation model
  ‚òê Add 3 helper functions:
    ‚Ä¢ _generate_patch_with_llm()
    ‚Ä¢ _apply_patch_safely()
    ‚Ä¢ _fallback_to_full_json()

Phase 3: Replace Node (15 min)
  ‚òê Create llm_edit_node_with_patch()
  ‚òê Keep old node as backup

Phase 4: Update DB (10 min)
  ‚òê Add patch_operations column
  ‚òê Update save_version() method

Phase 5: Update Graph (2 min)
  ‚òê Point to new node function

Phase 6: Test (10 min)
  ‚òê Test structured data path
  ‚òê Test JSON Patch path
  ‚òê Test fallback path
  ‚òê Verify DB storage

TOTAL: ~62 minutes

===============================================================================
üéØ WHAT'S CUSTOMIZED FOR YOUR SCHEMA
===============================================================================

Your Schema:
  ‚úì acute_toxicity, skin_irritation, etc. (arrays of objects)
  ‚úì NOAEL, DAP (metric arrays)
  ‚úì Required fields: reference, data, source, statement, replaced
  ‚úì inci, cas, category, isSkip

Helper Functions Know About:
  ‚úì All your field names
  ‚úì Required field validation
  ‚úì Auto-fill missing fields with defaults
  ‚úì Array append operations (/-) 
  ‚úì Your 3 modification types

System Prompt Includes:
  ‚úì Your exact JSON structure
  ‚úì TYPE 1: Toxicology Data Addition
  ‚úì TYPE 2: DAP Update
  ‚úì TYPE 3: NOAEL Update
  ‚úì Examples with correct paths

===============================================================================
üìä YOUR THREE PATHS
===============================================================================

PATH 1: Structured Data (Fastest - No LLM)
  Input: "Oral LD50: 500 mg/kg, reference: Study 2023"
  Flow: Extract ‚Üí Direct update ‚Üí Generate patch for tracking
  Time: ~100ms
  ‚ú® Enhanced with patch tracking

PATH 2: JSON Patch (New Reliable Path)
  Input: "Add NOAEL value of 100 mg/kg"
  Flow: LLM generates patch ‚Üí Validate ‚Üí Apply ‚Üí Save
  Time: ~1-2s
  ‚ú® NEW: More reliable than full JSON

PATH 3: Fallback (Complex Cases)
  Input: "Update everything comprehensively"
  Flow: Full JSON generation (your original method)
  Time: ~2-3s
  ‚úÖ Safety net unchanged

===============================================================================
üîß KEY CODE SNIPPETS
===============================================================================

1. Add Model:
   class JSONPatchOperation(BaseModel):
       op: Literal["add", "remove", "replace"]
       path: str
       value: Optional[Any] = None

2. Setup Structured LLM:
   llm = ChatOpenAI(model="gpt-4o-mini", temperature=0)
   structured_llm = llm.with_structured_output(JSONPatchOperation)

3. Generate Patch:
   patch_op = _generate_patch_with_llm(
       llm=structured_llm,
       current_json=current_json,
       user_input=state["user_input"],
       current_inci=current_inci
   )

4. Apply Patch:
   updated_json, success = _apply_patch_safely(
       current_json=current_json,
       patch_op=patch_op
   )

5. Save with Patches:
   db.save_version(
       conversation_id=conversation_id,
       data=updated_json,
       modification_summary=f"{patch_op.op} at {patch_op.path}",
       patch_operations=[patch_op.model_dump()]  # ‚ú® NEW
   )

===============================================================================
üìù DATABASE UPDATE
===============================================================================

SQL:
  ALTER TABLE json_versions ADD COLUMN patch_operations TEXT;

Python (save_version):
  def save_version(self, ..., patch_operations: Optional[List[Dict]] = None):
      version = JSONVersion(...)
      
      if patch_operations:  # ‚ú® NEW
          version.patch_operations = json.dumps(patch_operations)
      
      self.session.add(version)
      self.session.commit()

===============================================================================
‚úÖ VALIDATION FOR YOUR SCHEMA
===============================================================================

Auto-validates:
  ‚úì Toxicology entries have required fields
  ‚úì Auto-fills missing fields with defaults:
    ‚Ä¢ reference, data, source, statement: ""
    ‚Ä¢ replaced: False
  ‚úì Metric values are numeric
  ‚úì Paths start with /
  ‚úì Array operations use /-

Example:
  LLM generates: {"op": "add", "path": "/acute_toxicity/-", 
                  "value": {"data": "LD50=500"}}
  
  Validator adds: "reference": "", "source": "", "statement": "", 
                  "replaced": false
  
  Final value: Complete valid entry ‚úÖ

===============================================================================
üéì EXAMPLE OPERATIONS
===============================================================================

Example 1: Add Toxicology Data
  Input: "Add acute toxicity LD50 500 mg/kg, ref: Study2023"
  Patch: {"op": "add", "path": "/acute_toxicity/-", 
          "value": {"reference": "Study2023", "data": "LD50=500 mg/kg", ...}}
  Result: New entry in acute_toxicity array ‚úÖ

Example 2: Update NOAEL
  Input: "Set NOAEL to 100"
  Patch: {"op": "add", "path": "/NOAEL/-", "value": 100}
  Result: 100 added to NOAEL array ‚úÖ

Example 3: Update INCI
  Input: "Change INCI to Sodium Lauryl Sulfate"
  Patch: {"op": "replace", "path": "/inci", 
          "value": "Sodium Lauryl Sulfate"}
  Result: INCI field updated ‚úÖ

Example 4: Add CAS Number
  Input: "Add CAS 68585-34-2"
  Patch: {"op": "add", "path": "/cas/-", "value": "68585-34-2"}
  Result: CAS number added to array ‚úÖ

===============================================================================
üö® COMMON ISSUES & FIXES
===============================================================================

Issue: "JSONPatchOperation not defined"
Fix: Add imports at top

Issue: "structured_llm not found"
Fix: structured_llm = llm.with_structured_output(JSONPatchOperation)

Issue: "no such column: patch_operations"
Fix: ALTER TABLE json_versions ADD COLUMN patch_operations TEXT;

Issue: Missing required fields
Fix: Auto-handled by _apply_patch_safely() ‚úÖ

Issue: Always using fallback
Fix: Check generated patch with print(patch_op.model_dump())

===============================================================================
üìà EXPECTED IMPROVEMENTS
===============================================================================

Token Usage:
  Before: ~2000 tokens (full JSON)
  After:  ~50-100 tokens (patch)
  Savings: 75-95% üí∞

Reliability:
  Before: LLM can corrupt JSON structure
  After:  Validated patches, auto-fill missing fields
  Result: Fewer errors ‚úÖ

History:
  Before: Full JSON snapshots
  After:  Precise patches showing exact changes
  Result: Clear audit trail üìù

Speed:
  Path 1 (structured): Same (fast)
  Path 2 (patch): Faster (smaller LLM output)
  Path 3 (fallback): Same

===============================================================================
‚ú® BENEFITS FOR YOUR USE CASE
===============================================================================

‚úÖ Handles your complex schema
   ‚Ä¢ Arrays of objects with required fields
   ‚Ä¢ Metric arrays (NOAEL, DAP)
   ‚Ä¢ Multiple field types

‚úÖ Understands your modification types
   ‚Ä¢ TYPE 1: Toxicology data addition
   ‚Ä¢ TYPE 2: DAP updates
   ‚Ä¢ TYPE 3: NOAEL updates

‚úÖ Auto-validates and fixes
   ‚Ä¢ Adds missing required fields
   ‚Ä¢ Validates data types
   ‚Ä¢ Prevents corruption

‚úÖ Preserves all features
   ‚Ä¢ Structured data extraction (unchanged)
   ‚Ä¢ DB storage (enhanced)
   ‚Ä¢ Conversation tracking (unchanged)
   ‚Ä¢ INCI extraction (unchanged)

===============================================================================
üéØ START HERE
===============================================================================

Step 1: Open COMPLETE_TOXICOLOGY_INTEGRATION.md
Step 2: Follow Phase 1-6 (1 hour total)
Step 3: Test with your data
Step 4: Deploy!

Your helper functions are ready to go. Just follow the integration guide!

Good luck! üöÄ

===============================================================================
